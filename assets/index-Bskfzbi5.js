(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();class ${parseCustomPalette(e){const t=e.split(",").map(s=>s.trim().replace(/^#/,"")).filter(s=>s.length>0);if(t.some(s=>!/^[0-9a-fA-F]{6}$/.test(s)))throw new Error("Invalid hex code format. Use 6-digit codes like FFFFFF.");return t.map(s=>[parseInt(s.substring(0,2),16),parseInt(s.substring(2,4),16),parseInt(s.substring(4,6),16)])}rgbToLab(e){const[t,s,n]=e;let o=t/255,a=s/255,r=n/255;o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92,a=a>.04045?Math.pow((a+.055)/1.055,2.4):a/12.92,r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92;let d=(o*.4124+a*.3576+r*.1805)/.95047,l=(o*.2126+a*.7152+r*.0722)/1,i=(o*.0193+a*.1192+r*.9505)/1.08883;return d=d>.008856?Math.pow(d,1/3):7.787*d+16/116,l=l>.008856?Math.pow(l,1/3):7.787*l+16/116,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,[116*l-16,500*(d-l),200*(l-i)]}labToRgb(e){const[t,s,n]=e;let o=(t+16)/116,a=s/500+o,r=o-n/200;a=Math.pow(a,3)>.008856?Math.pow(a,3):(a-16/116)/7.787,o=Math.pow(o,3)>.008856?Math.pow(o,3):(o-16/116)/7.787,r=Math.pow(r,3)>.008856?Math.pow(r,3):(r-16/116)/7.787,a*=.95047,o*=1,r*=1.08883;let d=a*3.2406+o*-1.5372+r*-.4986,l=a*-.9689+o*1.8758+r*.0415,i=a*.0557+o*-.204+r*1.057;return d=d>.0031308?1.055*Math.pow(d,1/2.4)-.055:12.92*d,l=l>.0031308?1.055*Math.pow(l,1/2.4)-.055:12.92*l,i=i>.0031308?1.055*Math.pow(i,1/2.4)-.055:12.92*i,[Math.round(Math.max(0,Math.min(255,d*255))),Math.round(Math.max(0,Math.min(255,l*255))),Math.round(Math.max(0,Math.min(255,i*255)))]}labColorDistanceSq(e,t){const s=e[0]-t[0],n=e[1]-t[1],o=e[2]-t[2];return s*s+n*n+o*o}sampleLabPixels(e,t){const s=[],n=e.data,o=n.length/4,a=Math.max(1,Math.floor(o/t));for(let r=0;r<n.length;r+=4*a)n[r+3]>0&&s.push(this.rgbToLab([n[r],n[r+1],n[r+2]]));return s}kmeans(e,t,s=20){if(!e.length)return[];let n=[];const o=Array.from(new Set(e.map(a=>JSON.stringify(a)))).map(a=>JSON.parse(a));if(o.sort((a,r)=>a[0]-r[0]),o.length<=t)n=o.slice();else{const a=Math.floor(o.length/t);for(let r=0;r<t;r++)n.push(o[r*a])}for(let a=0;a<s;a++){const r=Array.from({length:n.length},()=>[]);for(const i of e){let h=0,w=1/0;for(let g=0;g<n.length;g++){const u=this.labColorDistanceSq(i,n[g]);u<w&&(w=u,h=g)}r[h].push(i)}const d=[];let l=!0;for(let i=0;i<n.length;i++){const h=r[i],w=n[i];if(!h.length)d[i]=w;else{const g=h.reduce((u,c)=>[u[0]+c[0],u[1]+c[1],u[2]+c[2]],[0,0,0]);d[i]=[g[0]/h.length,g[1]/h.length,g[2]/h.length]}this.labColorDistanceSq(d[i],w)>1e-4&&(l=!1)}if(n=d,l)break}return n}applyPaletteQuantization(e,t){const s=t.map(l=>this.rgbToLab(l)),{width:n,height:o,data:a}=e,r=new Uint8ClampedArray(a.length),d=new Map;for(let l=0;l<a.length;l+=4){const i=a[l],h=a[l+1],w=a[l+2],g=a[l+3];if(g===0){r.set([0,0,0,0],l);continue}const u=i<<16|h<<8|w;let c=d.get(u);if(!c){const P=this.rgbToLab([i,h,w]);let x=0,m=1/0;for(let I=0;I<s.length;I++){const f=this.labColorDistanceSq(P,s[I]);f<m&&(m=f,x=I)}c=t[x],d.set(u,c)}r.set([c[0],c[1],c[2],g],l)}return{data:r,width:n,height:o}}estimateDownscaleResolution(e,t,s){const n=Math.max(e,t);return Math.max(1,Math.round(n*(2/Math.sqrt(n*s*.5))))}resizeNearestNeighbor(e,t,s){const{data:n,width:o,height:a}=e,r=new Uint8ClampedArray(t*s*4),d=o/t,l=a/s;for(let i=0;i<s;i++)for(let h=0;h<t;h++){const w=Math.floor(h*d),u=(Math.floor(i*l)*o+w)*4,c=(i*t+h)*4;r[c]=n[u],r[c+1]=n[u+1],r[c+2]=n[u+2],r[c+3]=n[u+3]}return{data:r,width:t,height:s}}modeDownscale(e,t,s,n=64,o=0){const a=e.data,r=e.width,d=e.height;if(t===r&&s===d)return{...e};const l=(u,c,P)=>{if(P===0)return[0,0,0,0];let x=0,m=-1/0,I=1/0;for(let f=0;f<P;f++){const M=u[f],p=c[f],D=.2126*M[0]+.7152*M[1]+.0722*M[2],C=p*(1+o*(1-D/255));(C>m||Math.abs(C-m)<1e-6&&D<I)&&(m=C,x=f,I=D)}return u[x]},i=new Uint8ClampedArray(r*s*4),h=d/s;for(let u=0;u<r;u++)for(let c=0;c<s;c++){const P=Math.floor(c*h),x=Math.min(d,Math.ceil((c+1)*h)),m=[],I=[];let f=0;for(let M=P;M<x;M++){const p=(M*r+u)*4,D=a[p],C=a[p+1],R=a[p+2],F=a[p+3];let S=-1;for(let b=0;b<f;b++)if(m[b][0]===D&&m[b][1]===C&&m[b][2]===R&&m[b][3]===F){S=b;break}S!==-1?I[S]++:f<n&&(m.push([D,C,R,F]),I.push(1),f++)}i.set(l(m,I,f),(c*r+u)*4)}const w=new Uint8ClampedArray(t*s*4),g=r/t;for(let u=0;u<s;u++)for(let c=0;c<t;c++){const P=Math.floor(c*g),x=Math.min(r,Math.ceil((c+1)*g)),m=[],I=[];let f=0;for(let M=P;M<x;M++){const p=(u*r+M)*4,D=i[p],C=i[p+1],R=i[p+2],F=i[p+3];let S=-1;for(let b=0;b<f;b++)if(m[b][0]===D&&m[b][1]===C&&m[b][2]===R&&m[b][3]===F){S=b;break}S!==-1?I[S]++:f<n&&(m.push([D,C,R,F]),I.push(1),f++)}w.set(l(m,I,f),(u*t+c)*4)}return{data:w,width:t,height:s}}processImage(e,t){const{width:s,height:n}=e;let o;if(t.paletteMode==="custom")o=this.parseCustomPalette(t.customPaletteStr);else{const d=t.fixPaletteData||e,l=this.sampleLabPixels(d,5e3);if(l.length===0)throw new Error("No non-transparent pixels found for palette generation.");o=this.kmeans(l,t.nColors).map(h=>this.labToRgb(h))}const a=this.applyPaletteQuantization(e,o);let r=a;if(t.shouldPixelize){const l=this.estimateDownscaleResolution(s,n,t.relativeScale)/Math.max(s,n),i=Math.max(1,Math.round(s*l)),h=Math.max(1,Math.round(n*l)),w=this.modeDownscale(a,i,h,t.nColors,t.weightC);let g=s,u=n;if(t.outputSize){const c=t.outputSize/Math.max(s,n);g=Math.max(1,Math.round(s*c)),u=Math.max(1,Math.round(n*c))}r=this.resizeNearestNeighbor(w,g,u)}return{finalImageData:r,paletteRGB:o}}}class A{listeners=[];event(e){return this.listeners.push(e),()=>this._remove(e)}fire(e){for(const t of this.listeners.slice())t(e)}_remove(e){this.listeners=this.listeners.filter(t=>t!==e)}}class G{constructor(e){this.el=e}onClick(e){this.el.addEventListener("click",e)}setDisabled(e){this.el.disabled=e}}class U{constructor(e,t){this.rangeEl=e,this.numberEl=t,this.rangeEl.addEventListener("input",()=>{this.numberEl.value=this.rangeEl.value}),this.numberEl.addEventListener("input",()=>{this.rangeEl.value=this.numberEl.value})}}class Y{constructor(e,t){this.name=t;const s=document.querySelector(e);if(!s)throw new Error(`RadioGroup root not found: ${e}`);this.root=s,this.root.addEventListener("change",n=>{const o=n.target;o&&o.name===t&&this.emitter.fire(o.value)})}root;emitter=new A;get value(){const e=this.root.querySelector(`input[name="${this.name}"]:checked`);if(!e)throw new Error(`No radio selected for ${this.name}`);return e.value}onChange(e){return this.emitter.event(e)}}class _{constructor(e){this.el=e,this.el.addEventListener("change",()=>void this.emitter.fire(this.el.files))}emitter=new A;onChange(e){return this.emitter.event(e)}getFiles(){return this.el.files}}class X{constructor(e){this.el=e}update(e,t=!1){this.el.textContent=e,this.el.classList.toggle("error",!!t)}}class j{lib;constructor(){this.lib=new $}async loadImageElementFromFile(e){return new Promise((t,s)=>{const n=new FileReader;n.onload=o=>{if(!o.target?.result||typeof o.target.result!="string")return s(new Error("Could not read file as data URL"));const a=new Image;a.onload=()=>t(a),a.onerror=()=>s(new Error("Image failed to load")),a.src=o.target.result},n.onerror=()=>s(new Error("FileReader error")),n.readAsDataURL(e)})}extractImageData(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const s=t.getContext("2d");if(!s)throw new Error("2D context unavailable");s.drawImage(e,0,0);const{data:n,width:o,height:a}=s.getImageData(0,0,e.width,e.height);return{data:n,width:o,height:a}}convertImageDataToDataUrl(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const s=t.getContext("2d");if(!s)throw new Error("2D context unavailable");const n=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height);return s.putImageData(n,0,0),t.toDataURL("image/png")}async processImageFile(e,t){const s=await this.loadImageElementFromFile(e),n=this.extractImageData(s);let o=null;if(t.fixPaletteFile){const l=await this.loadImageElementFromFile(t.fixPaletteFile);o=this.extractImageData(l)}const a={...t,fixPaletteData:o},r=this.lib.processImage(n,a);return{dataUrl:this.convertImageDataToDataUrl(r.finalImageData),paletteRGB:r.paletteRGB}}}document.addEventListener("DOMContentLoaded",()=>{const v=document.getElementById("image-input"),e=document.getElementById("fix-palette-input"),t=document.getElementById("custom-palette"),s=document.getElementById("process-btn"),n=document.getElementById("status"),o=document.getElementById("spinner"),a=document.getElementById("output-container"),r=document.getElementById("result-image"),d=document.getElementById("result-palette"),l=document.getElementById("n-colors"),i=document.getElementById("n-colors-slider"),h=document.getElementById("relative-scale"),w=document.getElementById("relative-scale-slider"),g=document.getElementById("weight-c"),u=document.getElementById("weight-c-slider"),c=document.getElementById("output-size"),P=document.getElementById("no-downscale"),x=document.getElementById("enable-pixelization"),m=document.getElementById("kmeans-options"),I=document.getElementById("custom-options");if([v,e,t,s,n,o,a,r,d,l,i,h,w,g,u,c,P,x,m,I].some(y=>!y))throw new Error("A required DOM element was not found. Check your HTML IDs.");const M=new G(s),p=new X(n),D=new _(v),C=new Y("#palette-mode-group","palette-mode");new U(i,l),new U(w,h),new U(u,g);const R=new j;let F="image.png";C.onChange(y=>{m.classList.toggle("hidden",y!=="kmeans"),I.classList.toggle("hidden",y!=="custom")}),x.addEventListener("change",()=>{document.getElementById("pixelization-options")?.classList.toggle("hidden",!x.checked)}),D.onChange(y=>{const L=y?.[0];if(!L)return;F=L.name;const z=new FileReader;z.onload=N=>{a.innerHTML="";const E=N.target?.result;if(typeof E!="string")return;const B=new Image;B.src=E,a.appendChild(B),p.update("Image loaded. Adjust settings and process.")},z.readAsDataURL(L)}),M.onClick(S);async function S(){const y=v.files?.[0];if(!y){p.update("Error: Please upload an image first.",!0);return}const L=parseInt(l.value,10),z=C.value,N=t.value;if(Number.isNaN(L)||L<2||L>64){p.update("Error: Number of colors must be between 2 and 64.",!0);return}if(z==="custom"&&!N.trim()){p.update("Error: Custom palette cannot be empty.",!0);return}b(!0),p.update("Processing started...");try{const E={paletteMode:z,nColors:L,shouldPixelize:x.checked,relativeScale:parseFloat(h.value),weightC:parseFloat(g.value),outputSize:c.value?parseInt(c.value,10):null,fixPaletteFile:e.files?.[0]||null,noDownscale:P.checked,customPaletteStr:N};p.update("Processing..."),await new Promise(O=>setTimeout(O,10));const B=await R.processImageFile(y,E);T(B.dataUrl,B.paletteRGB,F,E.shouldPixelize),p.update("Success! Processing complete.")}catch(E){const B=E instanceof Error?E.message:String(E);console.error(E),p.update(`Error: ${B}`,!0)}finally{b(!1)}}function b(y){M.setDisabled(y),o.classList.toggle("hidden",!y)}function T(y,L,z,N){a.innerHTML="",r.src=y,r.classList.remove("hidden"),a.appendChild(r),d.innerHTML="",L.forEach(O=>{const k=document.createElement("div");k.className="palette-color",k.style.backgroundColor=`rgb(${O[0]}, ${O[1]}, ${O[2]})`,k.title=`#${O.map(q=>q.toString(16).padStart(2,"0")).join("").toUpperCase()}`,d.appendChild(k)}),a.appendChild(d);const E=document.createElement("a");E.id="download-link",E.href=y;const B=z.replace(/\.[^.]+$/,"");E.download=(N?"pixelated_":"quantized_")+B+".png",E.textContent="Download Image",a.appendChild(E)}});
